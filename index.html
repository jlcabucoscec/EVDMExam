<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event Driven Exam</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--accent:#38bdf8;--muted:#94a3b8;--ok:#22c55e;--bad:#ef4444;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:#e5e7eb}
  header{padding:28px 16px;text-align:center;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,rgba(56,189,248,.08),transparent)}
  h1{margin:0 0 8px 0;font-size:clamp(22px,4vw,36px);letter-spacing:.2px}
  p.sub{margin:0;color:var(--muted);font-size:clamp(14px,2.3vw,16px)}
  main{max-width:900px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .question{font-size:18px;margin:6px 0 14px 0;line-height:1.4}
  .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .choice{padding:12px 14px;border-radius:12px;border:1px solid #243041;background:#0b1220;color:#e5e7eb;text-align:left;cursor:pointer;transition:transform .05s ease, border-color .2s ease}
  .choice:hover{transform:translateY(-1px);border-color:var(--accent)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  button{background:var(--accent);border:none;color:#05232e;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  #hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:12px 0}
  .pill{border:1px solid #1f2937;background:#0b1220;border-radius:999px;padding:6px 12px;font-size:13px;color:#cbd5e1}
  #result{font-size:18px;margin-top:6px;text-align:center}
  footer{color:var(--muted);text-align:center;padding:24px 12px}
  @media (max-width:720px){.choices{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>

  <div id="studentForm" class="card">
    <h2>Student Information</h2>
    <label>
      Last Name:
      <input type="text" id="lastName" required>
    </label>
    <label>
      First Name, Middle Name:
      <input type="text" id="firstName" required>
    </label>
    <label>
      Schedule:
      <input type="text" id="schedule" required>
    </label>
    <label>
      EDP Code:
      <input type="text" id="edpCode" required>
    </label>
    <label>
      Teacher:
      <select id="teacher" required>
        <option value="">-- Select Teacher --</option>
        <option value="Alangcas">Sir Arjay Alangcas</option>
        <option value="Villanueva">Sir Arnel Villanueva</option>
        <option value="Arrojado">Sir Sergie Arrojado</option>
        <option value="Maquilan">Sir Charlie Maquilan</option>
        <option value="Mariscal">Sir Michael Martin Mariscal</option>
        <option value="Prado">Sir Yestin Prado</option>
        <option value="Cababan">Sir Vincent John Cababan</option>
        <option value="Cabucos">Sir Jade Louis Cabucos</option>
        <option value="Quibol">Miss Hazel Quibol</option>
        <option value="Sadorra">Miss Gladymay Sadorra</option>
        <option value="Catarungan">Miss En Catarungan</option>
      </select>
    </label>

    <button id="startQuizBtn">Start Quiz</button>
  </div>


  <h1>Event Driven Programming — Exam</h1>
  <p class="sub">Inline Events • addEventListener • Callbacks • Promises • Async/Await • DOM & Timers • Fetch API</p>
</header>

<div id="quizContainer" style="display:none">
  <div id="hud">
    <span class="pill" id="testName">Loading Test...</span>
    <span class="pill" id="progress">Question 0/0</span>
    <span class="pill" id="timer">Time: 30s</span>
  </div>
  <div id="quiz"></div>
  <div class="card">
    <div class="question" id="result">Answer all questions to see your score.</div>
    <div class="controls" id="answerSummary"></div>
  </div>
</div>

<footer>Made for classroom use. Tip: Use it offline by saving this file.</footer>






<script>
let quizStartTime = null;
let sheetRowId = null;

document.getElementById("startQuizBtn").addEventListener("click", async () => {
  const lastName = document.getElementById("lastName").value.trim();
  const firstName = document.getElementById("firstName").value.trim();
  const schedule = document.getElementById("schedule").value.trim();
  const edpCode = document.getElementById("edpCode").value.trim();
  const teacher = document.getElementById("teacher").value;

  if (!lastName || !firstName || !schedule || !edpCode || !teacher) {
    alert("Please fill in all fields.");
    return;
  }

  quizStartTime = new Date();

  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycby5Dp0AHYd10uksgF0tjktL2-uZYjgsjyCoi0zmbySF5R6_KECF4qwLhE0xkfgIysG-Bg/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "start",
        date: quizStartTime.toISOString().split("T")[0],  // YYYY-MM-DD
        lastName,
        firstName,
        schedule,
        edpCode,
        teacher,
        startTime: quizStartTime.toLocaleString()
      })
    });

    const data = await res.json();

    if (data.status === "duplicate") {
      alert("This student already exists in the record. Please check your name.");
      return;
    }
    if (data.status !== "ok" || !data.rowId) {
      alert("Something went wrong. Please try again.");
      return;
    }

    // ✅ Safe to proceed
    sheetRowId = data.rowId;

    // Show quiz
    document.getElementById("studentForm").style.display = "none";
    document.getElementById("quizContainer").style.display = "block";

    // Update HUD
    document.getElementById("testName").textContent = `${firstName} ${lastName} — ${schedule}`;
    document.getElementById("progress").textContent = "Question 0/0";
    document.getElementById("timer").textContent = "Time: 30s";

    // Load teacher-specific tests
    await loadTestsForTeacher(teacher);

  } catch (err) {
    console.error(err);
    alert("Network error. Please try again.");
  }
});




function loadTestsForTeacher(teacher) {
  // Pick the quiz data file per teacher
  const url = (teacher === "Cabucos")
    ? "quiz-data-cabucos.json"
    : "quiz-data-cababan.json";

  return fetch(url)
    .then(res => res.json())
    .then(data => {
      tests = data.tests;
      testIndex = 0;
      testResults = [];
      loadTest(0);   // start the first test
    });
}




let tests = [];
let testIndex = 0;
let currentTest = null;
let questions = [];
let userAnswers = [];
let testResults = []; // Store answers & score per test
let score = 0;
let current = 0;
let timer;
let qTimeRemaining = []; 

const quizDiv = document.getElementById("quiz");
const progressEl = document.getElementById("progress");
const timerEl = document.getElementById("timer");
const testNameEl = document.getElementById("testName");
const resultEl = document.getElementById("result");
const answerSummary = document.getElementById("answerSummary");

function formatTime(s){
  const m=Math.floor(s/60).toString().padStart(2,"0");
  const sec=(s%60).toString().padStart(2,"0");
  return m+":"+sec;
}



function startQuestionTimer(index){
  clearInterval(timer);
  qTimeRemaining[index] = qTimeRemaining[index] || 30;

  // show immediately
  document.getElementById("timer").textContent = `Time Left: ${qTimeRemaining[index]}s`;

  timer = setInterval(()=>{
    qTimeRemaining[index]--;
    document.getElementById("timer").textContent = `Time Left: ${qTimeRemaining[index]}s`;
    if(qTimeRemaining[index] <= 0){
      clearInterval(timer);
      goToNextUnansweredOrNext(index);
    }
  },1000);
}



function goToNextUnansweredOrNext(fromIndex){
  const n = questions.length;

  // 1st pass: find next unanswered ahead
  for(let step=1; step<=n; step++){
    const i = (fromIndex + step) % n;
    if(userAnswers[i] === undefined){
      renderMCQQuestion(i);
      return;
    }
  }

  // 2nd pass: look for skipped ("-")
  for(let step=1; step<=n; step++){
    const i = (fromIndex + step) % n;
    if(userAnswers[i] === "-"){
      renderMCQQuestion(i);
      return;
    }
  }

  // if nothing left → finish this test
  clearInterval(timer);
  score = userAnswers.reduce((s, ans, j) => 
    s + (ans === questions[j].answer ? 1 : 0), 0
  );
  nextTest();
}



function updateNav(currentIndex){
  const navButtons = document.querySelectorAll("#nav button");
  navButtons.forEach((btn, i)=>{
    // reset style first
    btn.style.background = "";
    btn.style.color = "";
    btn.style.border = "1px solid #1f2937";

    if(userAnswers[i] !== undefined && userAnswers[i] !== "-"){
      // answered
      btn.style.background = "var(--ok)";
      btn.style.color = "#fff";
    } else if(userAnswers[i] === "-" && qTimeRemaining[i] > 0){
      // skipped / passed
      btn.style.background = "#facc15";  // yellow
      btn.style.color = "#000";
    } else if(qTimeRemaining[i] <= 0){
      // timed out
      btn.style.background = "var(--bad)";
      btn.style.color = "#fff";
    }

    // highlight the current question
    if(i === currentIndex){
      btn.style.border = "2px solid var(--accent)";
    }

    // show remaining time as small text
    btn.innerHTML = `${i+1}<br><span style="font-size:10px">${qTimeRemaining[i]}s</span>`;
  });
}





function renderMCQQuestion(index){
  clearInterval(timer);


  quizDiv.innerHTML="";
  const q = questions[index];
  progressEl.textContent=`Question ${index+1}/${questions.length}`;
  testNameEl.textContent=currentTest.testName;
  
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`<div class="question">${q.question}</div><div class="choices"></div>`;
  const choicesDiv = card.querySelector(".choices");
  
  q.choices.forEach((c,i)=>{
    const btn=document.createElement("button");
    btn.className="choice";
    btn.textContent=c;

    btn.addEventListener("click",()=>{
      userAnswers[index] = String.fromCharCode(65+i);
      goToNextUnansweredOrNext(index);
    });



    choicesDiv.appendChild(btn);
  });
  quizDiv.appendChild(card);

  // Controls: Pass + quick nav
  const controls = document.createElement("div");
  controls.className = "controls";
  controls.innerHTML = `<button id="passBtn">Pass</button><div id="nav"></div>`;
  card.appendChild(controls);

  // Numbered jump buttons
  const navDiv = controls.querySelector("#nav");
  questions.forEach((_, qi)=>{
    const b = document.createElement("button");
    b.className = "pill";
    b.textContent = qi + 1;
    b.addEventListener("click", ()=>{
      renderMCQQuestion(qi);
    });
    navDiv.appendChild(b);
  });

  // Pass leaves answer undefined and pauses this question's timer
  document.getElementById("passBtn").addEventListener("click", ()=>{
  if(userAnswers[index] === undefined){ 
    userAnswers[index] = "-"; // mark as skipped
  }
  goToNextUnansweredOrNext(index);
});


  // Disable choices if this question already timed out
  if(qTimeRemaining[index] <= 0){
    card.querySelectorAll(".choice").forEach(b=> b.disabled = true);
  }

  // start/resume this question's timer
  startQuestionTimer(index);
  updateNav(index);
}




function renderMatchingTest(){
  quizDiv.innerHTML="";
  testNameEl.textContent=currentTest.testName;
  progressEl.textContent="Matching Test";

  const card=document.createElement("div");
  card.className="card";

  let eventTypesHtml = "<p><strong>Event Types (Column B):</strong></p><ul>";
  for(const key in currentTest.eventTypes){
    eventTypesHtml += `<li>${key}: ${currentTest.eventTypes[key]}</li>`;
  }
  eventTypesHtml += "</ul>";

  let html=`<div class="question">${currentTest.instructions}</div><ol>`;
  currentTest.attributes.forEach((attr,i)=>{
    html+=`<li>${attr.attribute}: <input maxlength="1" style="width:30px;text-transform:uppercase" data-index="${i}" data-answer="${attr.type}"></li>`;
  });
  html+="</ol><button id='submit-match'>Submit</button>";
  
  card.innerHTML = eventTypesHtml + html;
  quizDiv.appendChild(card);

  document.getElementById("submit-match").addEventListener("click",()=>{
    userAnswers = [];
    score = 0;
    const inputs = card.querySelectorAll("input");
    inputs.forEach(inp=>{
      const ans = inp.value.toUpperCase() || "-";
      userAnswers.push(ans);
      if(ans===inp.dataset.answer) score++;
    });
    nextTest();
  });
}



function nextTest(){
  clearInterval(timer);
  // Save current test results
  testResults.push({
    testName: currentTest.testName,
    answers: [...userAnswers],
    score: score,
    total: currentTest.type==="mcq" ? questions.length : currentTest.attributes.length
  });

  testIndex++;
  if(testIndex<tests.length){
    loadTest(testIndex);
  } else {
    displayFinalResults();
  }
}

function displayFinalResults(){
  clearInterval(timer);
  quizDiv.innerHTML="";
  progressEl.textContent="All Tests Completed";
  resultEl.textContent="";

  let html="<h2>Quiz Summary</h2>";
  let totalScore = 0;
  testResults.forEach(test=>{
    html+=`<h3>${test.testName}</h3><ul>`;
    test.answers.forEach((ans,i)=>{
      html+=`<li>Q${i+1}: ${ans}</li>`;
    });
    html+=`</ul><p>Score: ${test.score}/${test.total}</p>`;
    totalScore += test.score;
  });
  html+=`<h3>Total Score: ${totalScore} points</h3>`;
  quizDiv.innerHTML = html;

  // ✅ Log end time + final score + all answers
finishQuiz(totalScore);

}



function finishQuiz(totalScore) {
  const quizEndTime = new Date();

  // Build a compact payload of ALL tests + answers
  const answersPayload = testResults.map(t => ({
    testName: t.testName,
    answers: t.answers,       // array like ["A","C","-","B",...]
    score: t.score,
    total: t.total
  }));

  fetch("YOUR_WEBAPP_URL", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "end",
      rowId: sheetRowId,             // from start
      endTime: quizEndTime.toLocaleString(),
      score: totalScore,             // overall score across tests
      answers: answersPayload        // ALL tests, ALL answers
    })
  }).catch(console.error);

  document.getElementById("result").textContent =
    `Your Total Score: ${totalScore} points`;
}





function loadTest(index){
  currentTest = tests[index];
  currentTest.type = currentTest.questions ? "mcq" : "match";
  questions = currentTest.questions || [];
  userAnswers = [];
  score = 0;
  current = 0;
  resultEl.textContent = "Answer all questions to see your score.";
  answerSummary.innerHTML = "";
  clearInterval(timer);

  if(currentTest.type === "mcq"){
    // 30 seconds per question
    qTimeRemaining = Array(questions.length).fill(30);
    renderMCQQuestion(0); // this will start the per-question timer
  } else {
    // matching test unchanged; no per-question timer for now
    qTimeRemaining = [];
    timerEl.textContent = "Time: —";
    renderMatchingTest();
}

}

</script>

</body>

</html>
